this may be because the incorrect passing of vpeak.
By doing so, the vpeak of the previous loop will be passed to the next loop.